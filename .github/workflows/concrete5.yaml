name: UI Tests

on:
  # The end to end test suite was introduced in WordPress 5.3.
  pull_request:
  push:
      branches:
          - main
          - 'release/**'
# Cancels all previous workflow runs for pull requests that have not completed.
concurrency:
  # The concurrency group contains the workflow name and the branch name for pull requests
  # or the commit hash for any other events.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  install:
    services:
      # Label used to access the service container
      concrete:
        # Docker Hub image
        image: mlocati/docker5:develop
        #
        ports:
          # Opens tcp port 6379 on the host and service container
          - 8080:80 
          - 33306:3306
        options: >-
          --health-cmd "mysqladmin ping -h 127.0.0.1 -u root"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    runs-on: ubuntu-latest
    container: cypress/browsers:node14.15.0-chrome86-ff82
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Cypress install
        uses: cypress-io/github-action@v2
        with:
          runTests: false
          wait-on: 'http://concrete:8080'

      - name: General debug information
        run: |
          npm --version
          node --version
          curl --version
          git --version
          svn --version

#   install-windows:
#     runs-on: windows-2019
#     services:
#       # Label used to access the service container
#       concrete:
#         # Docker Hub image
#         image: mlocati/docker5:develop
#         #
#         ports:
#           # Opens tcp port 6379 on the host and service container
#           - 8080:80 
#           - 33306:3306
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
# 
#       - name: Cypress install
#         uses: cypress-io/github-action@v2
#         with:
#           runTests: false
#           wait-on: 'http://concrete:8080'
# 
#       - name: General debug information
#         run: |
#           npm --version
#           node --version
#           curl --version
#           git --version
#           svn --version
# 
#       - name: Save build folder
#         uses: actions/upload-artifact@v2
#         with:
#           name: build
#           if-no-files-found: error
#           path: build

  ui-chrome-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container: cypress/browsers:node14.16.0-chrome90-ff88
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: "UI Tests - Chrome"
        uses: cypress-io/github-action@v2
        with:
          wait-on: "http://concrete:8080"
          wait-on-timeout: 120
          browser: chrome
          record: true
          group: "UI - Chrome"
          spec: cypress/integration/*
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          # Recommended: pass the GitHub token lets this action correctly
          # determine the unique run id necessary to re-run the checks
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#   ui-chrome-mobile-tests:
#     timeout-minutes: 15
#     runs-on: ubuntu-latest
#     container: cypress/browsers:node14.16.0-chrome90-ff88
#     needs: install
#     strategy:
#       # when one test fails, DO NOT cancel the other
#       # containers, because this will kill Cypress processes
#       # leaving the Dashboard hanging ...
#       # https://github.com/cypress-io/github-action/issues/48
#       fail-fast: false
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2# 

#       - name: Download the build folders
#         uses: actions/download-artifact@v2
#         with:
#           name: build
#           path: build

#       - name: "UI Tests - Chrome - Mobile"
#         uses: cypress-io/github-action@v2
#         with:
#           config: "viewportWidth=375,viewportHeight=667"
#           start: yarn start:ci
#           wait-on: "http://concrete:8080"
#           wait-on-timeout: 120
#           browser: chrome
#           record: true
#           group: "UI - Chrome - Mobile"
#           spec: cypress/tests/ui/*
#         env:

#           CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
#           # Recommended: pass the GitHub token lets this action correctly
#           # determine the unique run id necessary to re-run the checks
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ui-firefox-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node14.16.0-chrome90-ff88
      options: --user 1001
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: "UI Tests - Firefox"
        uses: cypress-io/github-action@v2
        with:
          wait-on: "http://concrete:8080"
          wait-on-timeout: 120
          browser: firefox
          record: true
          group: "UI - Firefox"
          spec: cypress/integration/*
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          # Recommended: pass the GitHub token lets this action correctly
          # determine the unique run id necessary to re-run the checks
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# DISABLED FOR NOW
#   ui-firefox-mobile-tests:
#     timeout-minutes: 15
#     runs-on: ubuntu-latest
#     container:
#       image: cypress/browsers:node14.16.0-chrome90-ff88
#       options: --user 1001
#     needs: install
#     strategy:
      # when one test fails, DO NOT cancel the other
      # containers, because this will kill Cypress processes
      # leaving the Dashboard hanging ...
      # https://github.com/cypress-io/github-action/issues/48
#       fail-fast: false
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2

#       - name: Download the build folders
#         uses: actions/download-artifact@v2
#         with:
#           name: build
#           path: build

#       - name: "UI Tests - Firefox - Mobile"
#         uses: cypress-io/github-action@v2
#         with:
#           config: "viewportWidth=375,viewportHeight=667"
#           start: yarn start:ci
#           wait-on: "http://concrete:8080"
#           wait-on-timeout: 120
#           browser: firefox
#           record: true
#           group: "UI - Firefox - Mobile"
#           spec: cypress/tests/ui/*
#         env:

#           CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
#           # Recommended: pass the GitHub token lets this action correctly
#           # determine the unique run id necessary to re-run the checks
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#   ui-windows-tests:
#     timeout-minutes: 40
#     runs-on: windows-2019
#     needs: install-windows
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
# 
#       - name: Download the build folders
#         uses: actions/download-artifact@v2
#         with:
#           name: build
#           path: build
# 
#       - name: "UI Tests - Electron - Windows"
#         uses: cypress-io/github-action@v2
#         with:
#           start: yarn start:ci
#           wait-on: "http://localhost:8080"
#           wait-on-timeout: 120
#           record: true
#           group: "UI - Electron - Windows"
#           spec: cypress/tests/ui/*
#         env:
#           CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
#           # Recommended: pass the GitHub token lets this action correctly
#           # determine the unique run id necessary to re-run the checks
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}